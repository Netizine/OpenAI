<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Projects\Netizine.OpenAI\src\Netizine.OpenAI\Infrastructure\JsonConverters\AnyOfConverter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ReSharper disable once CheckNamespace
namespace OpenAI.Infrastructure
{
    using System;
    using System.Linq;
    using System.Reflection;
    using Newtonsoft.Json;
    using Newtonsoft.Json.Linq;

    /// &lt;summary&gt;
    /// Converts a &lt;see cref=&quot;IAnyOf&quot;/&gt; to and from JSON.
    /// &lt;/summary&gt;
    public class AnyOfConverter : JsonConverter
    {
        /// &lt;summary&gt;
        /// Gets a value indicating whether this &lt;see cref=&quot;JsonConverter&quot;/&gt; can write JSON.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        ///     &lt;c&gt;true&lt;/c&gt; if this &lt;see cref=&quot;JsonConverter&quot;/&gt; can write JSON; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        public override bool CanWrite =&gt; true;

        /// &lt;summary&gt;
        /// Writes the JSON representation of the object.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;The &lt;see cref=&quot;JsonWriter&quot;/&gt; to write to.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;serializer&quot;&gt;The calling serializer.&lt;/param&gt;
        public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
        {
            switch (value)
            {
                case null:
                    serializer.Serialize(writer, null);
                    break;

                case IAnyOf anyOf:
                    serializer.Serialize(writer, anyOf.Value);
                    break;

                default:
                    throw new JsonSerializationException(
                        $&quot;Unexpected value when converting AnyOf. Expected IAnyOf, got {value.GetType()}.&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Reads the JSON representation of the object.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;reader&quot;&gt;The &lt;see cref=&quot;JsonReader&quot;/&gt; to read from.&lt;/param&gt;
        /// &lt;param name=&quot;objectType&quot;&gt;Type of the object.&lt;/param&gt;
        /// &lt;param name=&quot;existingValue&quot;&gt;The existing value of object being read.&lt;/param&gt;
        /// &lt;param name=&quot;serializer&quot;&gt;The calling serializer.&lt;/param&gt;
        /// &lt;returns&gt;The object value.&lt;/returns&gt;
        public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
        {
            if (reader.TokenType == JsonToken.Null)
            {
                return null;
            }

            object o = null;

            // Try to deserialize with each possible type
            var jToken = JToken.Load(reader);
            foreach (var type in objectType.GenericTypeArguments)
            {
                try
                {
                    using var subReader = jToken.CreateReader();
                    o = serializer.Deserialize(subReader, type);

                    // If deserialization succeeds, stop
                    break;
                }
                catch (JsonException)
                {
                    // Do nothing, just try the next type
                }
            }

            if (o == null)
            {
                throw new JsonSerializationException(
                    $&quot;Cannot deserialize the current JSON object into any of the expected types ({string.Join(&quot;, &quot;, objectType.GenericTypeArguments.Select(t =&gt; t.FullName))}).&quot;);
            }

            return Activator.CreateInstance(objectType, o);
        }

        /// &lt;summary&gt;
        /// Determines whether this instance can convert the specified object type.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;objectType&quot;&gt;Type of the object.&lt;/param&gt;
        /// &lt;returns&gt;
        ///     &lt;c&gt;true&lt;/c&gt; if this instance can convert the specified object type; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/returns&gt;
        public override bool CanConvert(Type objectType)
        {
            return typeof(IAnyOf).GetTypeInfo().IsAssignableFrom(objectType.GetTypeInfo());
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,42,21,46,1],[34,21,34,56,0],[35,21,35,27,0],[38,21,38,63,1],[39,21,39,27,1],[42,21,43,109,0],[57,13,57,52,1],[59,17,59,29,1],[62,13,62,29,1],[65,13,65,46,1],[66,22,66,30,1],[66,31,66,33,1],[66,34,66,65,1],[70,21,70,65,1],[71,21,71,65,1],[74,21,74,27,1],[76,17,76,38,1],[79,17,79,18,1],[82,13,82,27,1],[84,17,85,161,1],[85,161,85,171,1],[85,171,85,179,1],[88,13,88,60,1],[100,13,100,92,0]]);
    </script>
  </body>
</html>