<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Projects\Netizine.OpenAI\src\Netizine.OpenAI\Infrastructure\Public\OpenAIRequest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ReSharper disable once CheckNamespace
namespace OpenAI
{
    using System;
    using System.Collections.Generic;
    using System.Net.Http;
    using System.Net.Http.Headers;
    using System.Text;
    using OpenAI.Infrastructure.FormEncoding;

    /// &lt;summary&gt;
    /// Represents a request to OpenAI&#39;s API.
    /// &lt;/summary&gt;
    public class OpenAIRequest
    {
        private readonly BaseOptions options;

        /// &lt;summary&gt;Initializes a new instance of the &lt;see cref=&quot;OpenAIRequest&quot;/&gt; class.&lt;/summary&gt;
        /// &lt;param name=&quot;client&quot;&gt;The client creating the request.&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;The HTTP method.&lt;/param&gt;
        /// &lt;param name=&quot;path&quot;&gt;The path of the request.&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;The parameters of the request.&lt;/param&gt;
        /// &lt;param name=&quot;requestOptions&quot;&gt;The special modifiers of the request.&lt;/param&gt;
        public OpenAIRequest(
            IOpenAIClient client,
            HttpMethod method,
            string path,
            BaseOptions options,
            RequestOptions requestOptions)
        {
            if (client == null)
            {
                throw new ArgumentNullException(nameof(client));
            }

            this.options = options;

            this.Method = method;

            this.Uri = BuildUri(client, method, path, options, requestOptions);

            this.AuthorizationHeader = BuildAuthorizationHeader(client, requestOptions);

            this.OpenAIHeaders = BuildOpenAIHeaders(requestOptions);
        }

        /// &lt;summary&gt;The HTTP method for the request (GET, POST or DELETE).&lt;/summary&gt;
        public HttpMethod Method { get; }

        /// &lt;summary&gt;
        /// The URL for the request. If this is a GET or DELETE request, the URL also includes
        /// the request parameters in its query string.
        /// &lt;/summary&gt;
        public Uri Uri { get; }

        /// &lt;summary&gt;The value of the &lt;c&gt;Authorization&lt;/c&gt; header with the API key.&lt;/summary&gt;
        public AuthenticationHeaderValue AuthorizationHeader { get; }

        /// &lt;summary&gt;
        /// Dictionary containing OpenAI custom headers (&lt;c&gt;OpenAI-Organization&lt;/c&gt;...).
        /// &lt;/summary&gt;
        public IDictionary&lt;string, string&gt; OpenAIHeaders { get; }

        /// &lt;summary&gt;
        /// The body of the request. For POST requests, this will be either a
        /// &lt;c&gt;application/x-www-form-urlencoded&lt;/c&gt;, &lt;c&gt;multipart/form-data&lt;/c&gt; or a &lt;c&gt;application/json&lt;/c&gt; payload.
        /// For non-POST requests, this will be &lt;c&gt;null&lt;/c&gt;.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;This getter creates a new instance every time it is called.&lt;/remarks&gt;
        public HttpContent Content =&gt; BuildContent(this.Method, this.options);

        /// &lt;summary&gt;Returns a string that represents the &lt;see cref=&quot;OpenAIRequest&quot;/&gt;.&lt;/summary&gt;
        /// &lt;returns&gt;A string that represents the &lt;see cref=&quot;OpenAIRequest&quot;/&gt;.&lt;/returns&gt;
        public override string ToString()
        {
            return $&quot;&lt;{this.GetType().FullName} Method={this.Method} Uri={this.Uri}&gt;&quot;;
        }

        private static Uri BuildUri(
            IOpenAIClient client,
            HttpMethod method,
            string path,
            BaseOptions options,
            RequestOptions requestOptions)
        {
            var b = new StringBuilder();

            b.Append(requestOptions?.BaseUrl ?? client.ApiBase);
            b.Append(path);

            // ReSharper disable once InvertIf
            if ((method != HttpMethod.Post) &amp;&amp; (options != null))
            {
                var queryString = FormEncoder.CreateQueryString(options);

                // ReSharper disable once InvertIf
                if (!string.IsNullOrEmpty(queryString))
                {
                    b.Append(&quot;?&quot;);
                    b.Append(queryString);
                }
            }

            return new Uri(b.ToString());
        }

        private static AuthenticationHeaderValue BuildAuthorizationHeader(
            IOpenAIClient client,
            RequestOptions requestOptions)
        {
            string apiKey = requestOptions?.ApiKey ?? client.ApiKey;

            if (apiKey == null)
            {
                const string message = &quot;No API key provided. Set your API key using &quot;
                                       + &quot;`OpenAIConfiguration.ApiKey = \&quot;&lt;API-KEY&gt;\&quot;`. You can generate API keys &quot;
                                       + &quot;from the OpenAI Dashboard. See &quot;
                                       + &quot;https://beta.openai.com/docs/api-reference/authentication for details.&quot;;
                throw new OpenAIException(message);
            }

            return new AuthenticationHeaderValue(&quot;Bearer&quot;, apiKey);
        }

        private static Dictionary&lt;string, string&gt; BuildOpenAIHeaders(RequestOptions requestOptions)
        {
            var openAIHeaders = new Dictionary&lt;string, string&gt;();
            if (requestOptions != null)
            {
                if (!string.IsNullOrEmpty(requestOptions.OrganizationId))
                {
                    openAIHeaders.Add(&quot;OpenAI-Organization&quot;, requestOptions.OrganizationId);
                }
            }

            return openAIHeaders;
        }

        private static HttpContent BuildContent(HttpMethod method, BaseOptions options)
        {
            return method != HttpMethod.Post ? null : FormEncoder.CreateHttpContent(options);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,29,43,1],[31,13,31,32,1],[33,17,33,65,0],[36,13,36,36,1],[38,13,38,34,1],[40,13,40,80,1],[42,13,42,89,1],[44,13,44,69,1],[45,9,45,10,1],[48,36,48,40,1],[54,26,54,30,1],[57,64,57,68,1],[62,60,62,64,1],[70,39,70,78,1],[76,13,76,87,0],[86,13,86,41,1],[88,13,88,65,1],[89,13,89,28,1],[92,13,92,66,1],[94,17,94,74,1],[97,17,97,56,1],[99,21,99,35,1],[100,21,100,43,1],[104,13,104,42,1],[111,13,111,69,1],[113,13,113,32,1],[119,17,119,52,1],[122,13,122,68,1],[127,13,127,66,1],[128,13,128,40,1],[130,17,130,74,1],[132,21,132,93,1],[136,13,136,34,1],[141,13,141,94,1]]);
    </script>
  </body>
</html>