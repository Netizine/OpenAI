<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Projects\Netizine.OpenAI\tests\Netizine.OpenAI.Tests\Infrastructure\FormEncoding\FormEncoderTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
namespace OpenAI.Tests
{
    using System;
    using System.Collections.Generic;
    using System.Globalization;
    using System.IO;
    using System.Text;
    using System.Threading;
    using System.Threading.Tasks;
    using OpenAI;
    using OpenAI.Infrastructure.FormEncoding;
    using OpenAI.Tests.Infrastructure.TestData;
    using Xunit;

    public class FormEncoderTest : BaseOpenAITest
    {
        [Fact]
        public async Task CreateHttpContent_Null()
        {
            var content = FormEncoder.CreateHttpContent(null);

            Assert.NotNull(content);
            Assert.IsType&lt;FormUrlEncodedContent&gt;(content);

            Assert.Equal(&quot;application/x-www-form-urlencoded&quot;, content.Headers.ContentType.MediaType);
            Assert.Equal(&quot;utf-8&quot;, content.Headers.ContentType.CharSet);
            Assert.Equal(1, content.Headers.ContentType.Parameters.Count);

            var stream = await content.ReadAsStreamAsync();
            Assert.Equal(0, stream.Length);
        }

        [Fact]
        public async Task CreateHttpContent_NoStream()
        {
            var options = new TestOptions
            {
                List = new List&lt;object&gt; { 1, 2, 3 },
                String = &quot;String!&quot;,
            };
            var content = FormEncoder.CreateHttpContent(options);

            Assert.NotNull(content);
            Assert.IsType&lt;FormUrlEncodedContent&gt;(content);

            Assert.Equal(&quot;application/x-www-form-urlencoded&quot;, content.Headers.ContentType.MediaType);
            Assert.Equal(&quot;utf-8&quot;, content.Headers.ContentType.CharSet);
            Assert.Equal(1, content.Headers.ContentType.Parameters.Count);

            var stream = await content.ReadAsStreamAsync();
            Assert.Equal(44, stream.Length);
            var result = new StreamReader(stream).ReadToEnd();
            Assert.Equal(&quot;list[0]=1&amp;list[1]=2&amp;list[2]=3&amp;string=String!&quot;, result);
        }

        [Fact]
        public async Task CreateHttpContent_Stream()
        {
            var options = new TestOptions
            {
                List = new List&lt;object&gt; { 1, 2, 3 },
                Stream = new MemoryStream(Encoding.UTF8.GetBytes(&quot;Hello World!&quot;)),
                String = &quot;String!&quot;,
            };
            var content = FormEncoder.CreateHttpContent(options);

            Assert.NotNull(content);
            Assert.IsType&lt;MultipartFormDataContent&gt;(content);

            Assert.Equal(&quot;multipart/form-data&quot;, content.Headers.ContentType.MediaType);
            Assert.Equal(1, content.Headers.ContentType.Parameters.Count);

            var stream = await content.ReadAsStreamAsync();
            Assert.Equal(764, stream.Length);
            var result = new StreamReader(stream).ReadToEnd();

            // The boundary will be a random GUID, so we just check for substrings.
            // MultipartFormDataContentTest has more exhaustive tests with a non-random boundary.
            Assert.Contains(
                &quot;Content-Type: text/plain; charset=utf-8\r\nContent-Disposition: form-data; name=\&quot;list[0]\&quot;\r\n\r\n1\r\n&quot;,
                result);
            Assert.Contains(
                &quot;Content-Type: text/plain; charset=utf-8\r\nContent-Disposition: form-data; name=\&quot;list[1]\&quot;\r\n\r\n2\r\n&quot;,
                result);
            Assert.Contains(
                &quot;Content-Type: text/plain; charset=utf-8\r\nContent-Disposition: form-data; name=\&quot;list[2]\&quot;\r\n\r\n3\r\n&quot;,
                result);
            Assert.Contains(
                &quot;Content-Disposition: form-data; name=\&quot;stream\&quot;; filename=blob; filename*=utf-8&#39;&#39;blob\r\nContent-Type: application/octet-stream\r\n\r\nHello World!\r\n&quot;,
                result);
            Assert.Contains(
                &quot;Content-Type: text/plain; charset=utf-8\r\nContent-Disposition: form-data; name=\&quot;string\&quot;\r\n\r\nString!\r\n&quot;,
                result);
        }

        [Fact]
        public void CreateQueryString()
        {
            var testCases = new[]
            {
                // No data
                new
                {
                    data = new TestOptions { },
                    want = string.Empty,
                },

                // AnyOf
                new
                {
                    data = new TestOptions
                    {
                        AnyOf = &quot;foo&quot;,
                    },
                    want = &quot;any_of=foo&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        AnyOf = new Dictionary&lt;string, string&gt; { { &quot;foo&quot;, &quot;bar&quot; } },
                    },
                    want = &quot;any_of[foo]=bar&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        AnyOf = null, // AnyOf itself is null
                    },
                    want = string.Empty,
                },
                new
                {
                    data = new TestOptions
                    {
                        AnyOf = (string)null, // AnyOf is not null but AnyOf.Value is null
                    },
                    want = string.Empty,
                },
                new
                {
                    data = new TestOptions
                    {
                        AnyOf = (Dictionary&lt;string, string&gt;)null, // same as above, AnyOf.Value is null
                    },
                    want = string.Empty,
                },

                // Array
                new
                {
                    data = new TestOptions
                    {
                            Array = new[] { &quot;1&quot;, &quot;2&quot;, &quot;3&quot; },
                    },
                    want = &quot;array[0]=1&amp;array[1]=2&amp;array[2]=3&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                            Array = new string[] { },
                    },
                    want = &quot;array=&quot;,
                },

                // Bool
                new
                {
                    data = new TestOptions
                    {
                        Bool = false,
                    },
                    want = &quot;bool=False&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Bool = true,
                    },
                    want = &quot;bool=True&quot;,
                },

                // DateTime
                new
                {
                    data = new TestOptions
                    {
                        DateTime = DateTime.Parse(&quot;Sat, 01 Jan 2000 00:00:00Z&quot;),
                    },
                    want = &quot;datetime=946684800&quot;,
                },

                // Decimal
                new
                {
                    data = new TestOptions
                    {
                        Decimal = 1.2345m,
                    },
                    want = &quot;decimal=1.2345&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Decimal = 0.0m,
                    },
                    want = &quot;decimal=0.0&quot;,
                },

                // Dictionary
                new
                {
                    data = new TestOptions
                    {
                        Dictionary = new Dictionary&lt;string, object&gt; { { &quot;foo&quot;, &quot;bar&quot; } },
                    },
                    want = &quot;dictionary[foo]=bar&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Dictionary = new Dictionary&lt;string, object&gt; { { &quot;empty&quot;, string.Empty } },
                    },
                    want = &quot;dictionary[empty]=&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Dictionary = new Dictionary&lt;string, object&gt; { { &quot;null&quot;, null } },
                    },
                    want = &quot;dictionary[null]=&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Dictionary = new Dictionary&lt;string, object&gt;
                        {
                            { &quot;foo&quot;, new Dictionary&lt;string, object&gt; { { &quot;bar&quot;, &quot;baz&quot; } } },
                        },
                    },
                    want = &quot;dictionary[foo][bar]=baz&quot;,
                },

                // Enum
                new
                {
                    data = new TestOptions
                    {
                        Enum = TestOptions.TestEnum.TestOne,
                    },
                    want = &quot;enum=test_one&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Enum = TestOptions.TestEnum.TestTwo,
                    },
                    want = &quot;enum=TestTwo&quot;,
                },

                // List
                new
                {
                    data = new TestOptions
                    {
                        List = new List&lt;object&gt; { &quot;foo&quot;, &quot;bar&quot; },
                    },
                    want = &quot;list[0]=foo&amp;list[1]=bar&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        List = new List&lt;object&gt; { string.Empty, 0 },
                    },
                    want = &quot;list[0]=&amp;list[1]=0&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        List = new List&lt;object&gt; { },
                    },
                    want = &quot;list=&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        List = new List&lt;object&gt;
                        {
                            new Dictionary&lt;string, object&gt; { { &quot;foo&quot;, &quot;bar&quot; } },
                            new Dictionary&lt;string, object&gt; { { &quot;foo&quot;, &quot;baz&quot; } },
                        },
                    },
                    want = &quot;list[0][foo]=bar&amp;list[1][foo]=baz&quot;,
                },

                // Long
                new
                {
                    data = new TestOptions
                    {
                        Long = 123,
                    },
                    want = &quot;long=123&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        Long = 0,
                    },
                    want = &quot;long=0&quot;,
                },

                // String
                new
                {
                    data = new TestOptions
                    {
                        String = &quot;foo&quot;,
                    },
                    want = &quot;string=foo&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        String = string.Empty,
                    },
                    want = &quot;string=&quot;,
                },

                // StringEnum
                new
                {
                    data = new TestOptions
                    {
                        StringEnum = TestOptions.TestStringEnum.Foo,
                    },
                    want = &quot;string_enum=foo&quot;,
                },
                new
                {
                    data = new TestOptions
                    {
                        StringEnum = null,
                    },
                    want = string.Empty,
                },
            };

            foreach (var testCase in testCases)
            {
                Assert.Equal(testCase.want, FormEncoder.CreateQueryString(testCase.data));
            }
        }

        [Fact]
        public void EnumEncodeUnknownValue()
        {
            var options = new TestOptions
            {
                Enum = TestOptions.TestEnum.TestTwo,
            };
            Assert.Equal(&quot;enum=TestTwo&quot;, FormEncoder.CreateQueryString(options));
        }

        [Fact]
        public void EnumEncodeValidValue()
        {
            var options = new TestOptions
            {
                Enum = TestOptions.TestEnum.TestOne,
            };
            Assert.Contains(&quot;enum=test_one&quot;, FormEncoder.CreateQueryString(options));
        }

        [Fact]
        public void IgnoresCulture()
        {
            var currentCulture = Thread.CurrentThread.CurrentCulture;

            try
            {
                Thread.CurrentThread.CurrentCulture = new CultureInfo(&quot;fr-FR&quot;);

                var dec = 123.45m;
                Assert.Equal(&quot;123,45&quot;, dec.ToString(CultureInfo.CurrentCulture));

                var options = new TestOptions { Decimal = dec };
                Assert.Equal(&quot;decimal=123.45&quot;, FormEncoder.CreateQueryString(options));
            }
            finally
            {
                Thread.CurrentThread.CurrentCulture = currentCulture;
            }
        }

        [Fact]
        public void UrlEncodesKeysAndValues()
        {
            var options = new TestOptions
            {
                Dictionary = new Dictionary&lt;string, object&gt;
                    {
                        { &quot;#&quot;, &quot;1 2 3&quot; },
                        { &quot;bar&amp;baz&quot;, &quot;+foo?&quot; },
                    },
                String = &quot;[&#233;&#224;&#252;]&quot;,
            };
            Assert.Equal(
                &quot;dictionary[%23]=1+2+3&amp;dictionary[bar%26baz]=%2Bfoo%3F&amp;string=[%C3%A9%C3%A0%C3%BC]&quot;,
                FormEncoder.CreateQueryString(options));
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,13,20,63,1],[22,13,22,37,1],[23,13,23,59,1],[25,13,25,102,1],[26,13,26,72,1],[27,13,27,75,1],[29,13,29,60,1],[30,13,30,44,1],[31,9,31,10,1],[36,13,40,15,1],[41,13,41,66,1],[43,13,43,37,1],[44,13,44,59,1],[46,13,46,102,1],[47,13,47,72,1],[48,13,48,75,1],[50,13,50,60,1],[51,13,51,45,1],[52,13,52,63,1],[53,13,53,82,1],[54,9,54,10,1],[59,13,64,15,1],[65,13,65,66,1],[67,13,67,37,1],[68,13,68,62,1],[70,13,70,88,1],[71,13,71,75,1],[73,13,73,60,1],[74,13,74,46,1],[75,13,75,63,1],[79,13,81,25,1],[82,13,84,25,1],[85,13,87,25,1],[88,13,90,25,1],[91,13,93,25,1],[94,9,94,10,1],[99,13,226,15,1],[362,22,362,34,1],[362,35,362,37,1],[362,38,362,47,1],[364,17,364,91,1],[366,9,366,10,1],[371,13,374,15,1],[375,13,375,82,1],[376,9,376,10,1],[381,13,384,15,1],[385,13,385,86,1],[386,9,386,10,1],[391,13,391,70,1],[395,17,395,80,1],[397,17,397,35,1],[398,17,398,82,1],[400,17,400,65,1],[401,17,401,88,1],[402,13,402,14,1],[405,17,405,70,1],[406,13,406,14,1],[407,9,407,10,1],[412,13,420,15,1],[421,13,423,57,1],[424,9,424,10,1]]);
    </script>
  </body>
</html>