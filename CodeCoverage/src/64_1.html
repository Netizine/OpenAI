<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Projects\Netizine.OpenAI\tests\Netizine.OpenAI.Tests\OpenAIMockHandler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
namespace OpenAI.Tests
{
    using System;
    using System.Diagnostics;
    using System.IO;
    using System.Net;
    using System.Net.Sockets;
    using System.Threading;

    public static class OpenAIMockHandler
    {
        private static Process process;

        private static int port = -1;

        /// &lt;summary&gt;
        /// Gets the port on which openai-mock is listening, or -1 if no openai-mock process was
        /// started.
        /// &lt;/summary&gt;
        public static int Port { get =&gt; port; }

        /// &lt;summary&gt;
        /// Starts a openai-mock process on an available port, if necessary.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;True if a openai-mock process was started, false otherwise.&lt;/returns&gt;
        public static bool StartOpenAIMock()
        {
            // var specPath = Path.GetFullPath(&quot;openapi/spec3.json&quot;);
            // var fixturesPath = Path.GetFullPath(&quot;openapi/fixtures3.json&quot;);
            //
            // if (!File.Exists(specPath))
            // {
            //     return false;
            // }

            if ((process != null) &amp;&amp; !process.HasExited)
            {
                Console.WriteLine($&quot;openai-mock is already running on port #{port}&quot;);
                return true;
            }

            port = FindAvailablePort();

            Console.WriteLine($&quot;Starting openai-mock on port #{port}...&quot;);

            process = new Process
            {
                StartInfo = new ProcessStartInfo
                {
                    FileName = &quot;openai-mock&quot;,
                    Arguments = $&quot;--port {port}&quot;,
                    CreateNoWindow = true,
                    UseShellExecute = false,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                },
            };
            try
            {
                process.Start();
            }
            catch (Exception e)
            {
                Console.Error.WriteLine($&quot;Error while starting openai-mock, error message = {e.Message}&quot;);
                Environment.Exit(1);
            }

            process.BeginOutputReadLine();
            Thread.Sleep(1000);

            if (process.HasExited)
            {
                Console.Error.WriteLine($&quot;openai-mock terminated early, status code = {process.ExitCode}&quot;);
                Environment.Exit(1);
            }

            Console.WriteLine($@&quot;Started openai-mock, PID = #{process.Id}&quot;);

            return true;
        }

        /// &lt;summary&gt;
        /// Stop the openai-mock process if one was started.
        /// &lt;/summary&gt;
        public static void StopOpenAIMock()
        {
            if ((process == null) || process.HasExited)
            {
                return;
            }

            Console.WriteLine(&quot;Stopping openai-mock...&quot;);
            process.Kill();
            process = null;
            port = -1;
            Console.WriteLine(&quot;Stopped openai-mock&quot;);
        }

        /// &lt;summary&gt;Finds an available TCP port.&lt;/summary&gt;
        /// &lt;returns&gt;The available port.&lt;/returns&gt;
        private static int FindAvailablePort()
        {
            TcpListener l;
            int availablePort;
            var portVariable = Environment.GetEnvironmentVariable(&quot;OPENAI_MOCK_PORT&quot;);
            if (!string.IsNullOrEmpty(portVariable))
            {
                if (!int.TryParse(portVariable, out var environmentalPort))
                {
                    l = new TcpListener(IPAddress.Loopback, 0);
                    l.Start();
                    availablePort = ((IPEndPoint)l.LocalEndpoint).Port;
                    l.Stop();
                    return availablePort;
                }

                return environmentalPort;
            }
            
            l = new TcpListener(IPAddress.Loopback, 0);
            l.Start();
            availablePort = ((IPEndPoint)l.LocalEndpoint).Port;
            l.Stop();
            return availablePort;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[14,9,14,38,1],[20,41,20,45,1],[36,13,36,57,1],[38,17,38,86,0],[39,17,39,29,0],[42,13,42,40,1],[44,13,44,75,1],[46,13,57,15,1],[60,17,60,33,1],[61,13,61,14,1],[62,13,62,32,0],[64,17,64,107,0],[65,17,65,37,0],[66,13,66,14,0],[68,13,68,43,1],[69,13,69,32,1],[71,13,71,35,1],[73,17,73,108,0],[74,17,74,37,0],[77,13,77,77,1],[79,13,79,25,1],[87,13,87,56,1],[89,17,89,24,0],[92,13,92,58,1],[93,13,93,28,1],[94,13,94,28,1],[95,13,95,23,1],[96,13,96,54,1],[97,9,97,10,1],[105,13,105,87,1],[106,13,106,53,1],[108,17,108,76,1],[110,21,110,64,0],[111,21,111,31,0],[112,21,112,72,0],[113,21,113,30,0],[114,21,114,42,0],[117,17,117,42,1],[120,13,120,56,0],[121,13,121,23,0],[122,13,122,64,0],[123,13,123,22,0],[124,13,124,34,0]]);
    </script>
  </body>
</html>